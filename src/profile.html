<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Profile - Gym App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    const API_BASE = 'http://localhost:4000/api';
    function getToken(){ return localStorage.getItem('token'); }
    function clearToken(){ localStorage.removeItem('token'); }

    async function apiFetch(path, options = {}) {
      const headers = options.headers || {};
      headers['Content-Type'] = 'application/json';
      const token = getToken();
      if (token) headers['Authorization'] = 'Bearer ' + token;
      const res = await fetch(API_BASE + path, { ...options, headers });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) { alert(data.message || 'Error'); throw new Error(data.message || 'Error'); }
      return data;
    }

    async function loadMe() {
      try {
        const me = await apiFetch('/me', { method: 'GET' });
        document.getElementById('me-json').textContent = JSON.stringify(me, null, 2);

        // prefill form
        const form = document.getElementById('profile-form');
        form.name.value = me.name || '';
        form.gender.value = me.gender || '';
        form.heightCm.value = me.heightCm || '';
        form.weightKg.value = me.weightKg || '';
        form.experienceLevel.value = me.experienceLevel || '';
        form.goal.value = me.goal || '';
        form.activityLevel.value = me.activityLevel || '';
        form.healthFlags.value = me.healthFlags || '';
        if (me.birthDate) {
          form.birthDate.value = me.birthDate.slice(0, 10);
        }
      } catch (err) {
        console.error(err);
        if (!getToken()) {
          window.location.href = 'login.html';
        }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (!getToken()) {
        window.location.href = 'login.html';
        return;
      }

      loadMe();

      document.getElementById('profile-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const f = e.target;
        const payload = {
          name: f.name.value || null,
          gender: f.gender.value || null,
          birthDate: f.birthDate.value || null,
          heightCm: f.heightCm.value ? Number(f.heightCm.value) : null,
          weightKg: f.weightKg.value ? Number(f.weightKg.value) : null,
          experienceLevel: f.experienceLevel.value || null,
          goal: f.goal.value || null,
          activityLevel: f.activityLevel.value || null,
          healthFlags: f.healthFlags.value || null,
        };
        try {
          const me = await apiFetch('/me/profile', {
            method: 'PUT',
            body: JSON.stringify(payload),
          });
          document.getElementById('me-json').textContent = JSON.stringify(me, null, 2);
          alert('Profile updated');
        } catch (err) {
          console.error(err);
        }
      });

      document.getElementById('btn-logout').addEventListener('click', () => {
        clearToken();
        window.location.href = 'login.html';
      });
    });
  </script>
</head>
<body class="min-h-screen bg-gray-100">
  <div class="max-w-4xl mx-auto py-10 px-4">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">My Profile</h1>
      <button id="btn-logout"
              class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
        Logout
      </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <!-- Left: profile JSON -->
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-2">Raw data (/api/me)</h2>
        <pre id="me-json" class="text-sm bg-gray-50 p-3 rounded-lg overflow-x-auto"></pre>
      </div>

      <!-- Right: form -->
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-4">Update Profile</h2>
        <form id="profile-form" class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1">Name</label>
            <input name="name" class="w-full px-3 py-2 border rounded-lg" />
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">Gender</label>
              <input name="gender" placeholder="male/female"
                     class="w-full px-3 py-2 border rounded-lg" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Birth date</label>
              <input type="date" name="birthDate"
                     class="w-full px-3 py-2 border rounded-lg" />
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">Height (cm)</label>
              <input type="number" name="heightCm"
                     class="w-full px-3 py-2 border rounded-lg" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Weight (kg)</label>
              <input type="number" name="weightKg"
                     class="w-full px-3 py-2 border rounded-lg" />
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Experience level</label>
            <input name="experienceLevel" placeholder="beginner/intermediate/advanced"
                   class="w-full px-3 py-2 border rounded-lg" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Goal</label>
            <input name="goal" placeholder="lose_fat/gain_muscle/general_health"
                   class="w-full px-3 py-2 border rounded-lg" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Activity level</label>
            <input name="activityLevel" placeholder="low/moderate/high"
                   class="w-full px-3 py-2 border rounded-lg" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Health flags</label>
            <input name="healthFlags" placeholder="hypertension,knee_pain"
                   class="w-full px-3 py-2 border rounded-lg" />
          </div>
          <button type="submit"
                  class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 mt-2">
            Save
          </button>
        </form>
      </div>
    </div>
  </div>
</body>
</html>

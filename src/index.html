<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gym App Simple Frontend</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <h1>Gym App Test Frontend</h1>

  <!-- AUTH -->
  <section>
    <h2>Register</h2>
    <form id="register-form">
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <input type="text" name="name" placeholder="Name" />
      <button type="submit">Register</button>
    </form>
  </section>

  <section>
    <h2>Login</h2>
    <form id="login-form">
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
    <p>Token: <span id="token-display"></span></p>
  </section>

  <!-- PROFILE -->
  <section>
    <h2>My Profile (/api/me)</h2>
    <button id="btn-load-me">Load Me</button>
    <pre id="me-output"></pre>

    <h3>Update Profile</h3>
    <form id="profile-form">
      <input type="text" name="name" placeholder="Name" />
      <input type="text" name="gender" placeholder="Gender (male/female)" />
      <input type="date" name="birthDate" placeholder="Birth Date" />
      <input type="number" name="heightCm" placeholder="Height (cm)" />
      <input type="number" name="weightKg" placeholder="Weight (kg)" />
      <input type="text" name="experienceLevel" placeholder="Experience (beginner...)" />
      <input type="text" name="goal" placeholder="Goal (lose_fat/gain_muscle/...)" />
      <input type="text" name="activityLevel" placeholder="Activity (low/moderate/high)" />
      <input type="text" name="healthFlags" placeholder="Health flags" />
      <button type="submit">Save Profile</button>
    </form>
  </section>

  <script>
    const API_BASE = 'http://localhost:4000/';
    let token = null;

    function setToken(newToken) {
      token = newToken;
      document.getElementById('token-display').textContent = token || '(none)';
    }

    async function apiFetch(path, options = {}) {
      const headers = options.headers || {};
      headers['Content-Type'] = 'application/json';
      if (token) {
        headers['Authorization'] = 'Bearer ' + token; // Bearer token [web:215][web:218]
      }
      const res = await fetch(API_BASE + path, {
        ...options,
        headers,
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        alert('Error ' + res.status + ': ' + (data.message || JSON.stringify(data)));
        throw new Error(data.message || 'Request failed');
      }
      return data;
    }

    // REGISTER
    document.getElementById('register-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const body = {
        email: form.email.value,
        password: form.password.value,
        name: form.name.value,
      };
      try {
        const data = await apiFetch('/auth/register', {
          method: 'POST',
          body: JSON.stringify(body),
        });
        setToken(data.token);
        alert('Registered & logged in');
      } catch (err) {
        console.error(err);
      }
    });

    // LOGIN
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const body = {
        email: form.email.value,
        password: form.password.value,
      };
      try {
        const data = await apiFetch('/auth/login', {
          method: 'POST',
          body: JSON.stringify(body),
        });
        setToken(data.token);
        alert('Logged in');
      } catch (err) {
        console.error(err);
      }
    });

    // GET /me
    document.getElementById('btn-load-me').addEventListener('click', async () => {
      try {
        const me = await apiFetch('/me', { method: 'GET' });
        document.getElementById('me-output').textContent = JSON.stringify(me, null, 2);
      } catch (err) {
        console.error(err);
      }
    });

    // PUT /me/profile
    document.getElementById('profile-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const payload = {};
      for (const [key, value] of formData.entries()) {
        if (value === '') continue;
        if (key === 'heightCm' || key === 'weightKg') {
          payload[key] = Number(value);
        } else {
          payload[key] = value;
        }
      }
      try {
        const me = await apiFetch('/me/profile', {
          method: 'PUT',
          body: JSON.stringify(payload),
        });
        document.getElementById('me-output').textContent = JSON.stringify(me, null, 2);
        alert('Profile updated');
      } catch (err) {
        console.error(err);
      }
    });
  </script>
</body>
</html>
